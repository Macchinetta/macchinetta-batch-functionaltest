= 非同期実行(DBポーリング)の機能試験
:table-caption!:
:icons: font
:sectnums!:

== テストケース
テストケースクラス：jp.co.ntt.fw.macchinetta.batch.functionaltest.ch04.AsyncJobWithDBSpec

[cols="5,25a,70a", options="headers"]
.テストケース一覧
|===
|項番
|テストケース
|確認事項

|1
|<<dbPollingSequence>>
|
. デーモンの起動
. ポーリング
. ジョブの実行
. デーモンの停止

|1-1
|<<launchDaemon>>
|
* AsyncBatchDaemonが起動することを確認する

|1-2
|<<polling>>
|
* 指定された間隔でポーリングタスクが起動すること
* デーモンの起動から指定された時間で遅延して最初のポーリングが起動すること
* 指定した件数でジョブ要求が取得されること

|1-3
|<<executeJob>>
|
* ジョブ要求に設定された内容でジョブが起動すること
* 同時並行数より多くのジョブが起動しないこと
* ジョブ終了後にjob_execution_idがジョブ要求テーブルに更新されること

|1-4
|<<stopDaemon>>
|
* 指定したファイルを作成すると非同期デーモンが停止すること
* ジョブが終了するまで待機して、デーモンが停止する

|2
|<<pollingStatusTransition>>
|
* INIT -> INIT
** 同時実行数を超える
** 楽観ロックで排他された場合
* INIT -> POLLED
** 通常実行のため、項番1で自然に確認される
* POLLED -> EXECUTED
** 通常実行のため、項番1で自然に確認される

|3
|<<abnormalityDBPolling>>
|
* ジョブが利用するデータソース(``jobDataSource``)への変更はトランザクションがロールバックされる
* リトライせずに次のポーリングタスクを実施
* JobExecutionIdの更新に失敗したときログが出力される

|4
|<<recoveryJobAbnormalTermination>>
|
* リラン
* リスタート
* 停止

|5
|<<customizingJobRequestTable>>
|
* カスタマイズしたテーブルおよびSQLが利用できる

|6
|<<customizingClock>>
|
* カスタマイズしたクロックでポーリングタスクが実施されること

|7
|<<multipleDaemons>>
|
* 楽観ロック
** ジョブが排他的に実行される

|8
|<<modularization>>
|
* Beanの上書き
* モジュール化されて独立したBean

|===

== 試験項目一覧
各試験の項目一覧を示す。

:sectnums:
:leveloffset: -1

.試験実施時の共通項目
* ジョブ要求テーブルへのアクセスはDBUnitを利用する
** 試験検証をし易くするため、できる限りjob_seq_idは自動採番は使用せずに直接指定して登録する
* ジョブリポジトリへのアクセスはDBUnitかJobExploreを利用する

[[dbPollingSequence]]
=== DBポーリング処理シーケンスのテスト
DBポーリングの処理シーケンスを確認する。

[[launchDaemon]]
==== デーモン起動のテスト
非同期デーモンの起動を確認する。

icon:share[] <<polling>>、<<executeJob>>、<<stopDaemon>>のテストを正常系としてまとめている。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

.4+|1
.4+|正常系 +
非同期型起動(DBポーリング)
|<<launchDaemon>> +
非同期デーモンが起動されること
.3+|
* 引数なしでAsyncBatchDaemonを起動する
** ポーリング間隔=5秒、開始遅延=10秒に設定
** ジョブ要求にジョブパラメータを設定して登録する
|
* ログ出力により、正常に起動されたこと

a|<<polling>>

* 指定された間隔でポーリングタスクが起動すること
* デーモンの起動から指定された時間で遅延して最初のポーリングが起動すること
a|
* ログ出力により、非同期デーモン起動後から10秒遅延して最初のポーリングが開始していること
* ログ出力により、5秒間隔でポーリングが実行されていること

a|<<executeJob>>

* ジョブ要求に設定された内容でジョブが起動すること
* ジョブ終了後にjob_execution_idがジョブ要求テーブルに更新されること
a|
* ログ出力により、ジョブが正常起動・終了したこと
* ジョブ要求テーブルがEXECUTEDになり、job_execution_idが更新されていること
* ジョブリポジトリにジョブ要求で設定した、ジョブ名とジョブパラメータが登録されていること
** job_execution_idを利用してレコードを特定する。

a|<<stopDaemon>> +
非同期デーモンが停止されること
a|
* 引数なしでAsyncBatchDaemonを停止する
** 非同期デーモンが起動中に、指定したファイル以外のファイルを作成する
** 非同期デーモンが起動中に、指定したファイルを作成する
a|
. 指定したファイル以外のファイルを作成した時
* ログ出力により、終了しないこと
* ログ出力により、終了ファイルが検知されないこと
. 指定したファイルを作成した時
* ログ出力により、正常に終了されたこと
* ログ出力により、終了ファイルが検知されたこと


|===

[[polling]]
==== ポーリングのテスト
ポーリング処理を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
非同期型起動(DBポーリング)
|指定した件数でジョブ要求が取得されること
|
* 初期データとしてジョブ要求を20件登録しておく
* ポーリング件数(＝同時並行数)を5件に設定して、非同期デーモンを起動する
* ステータスの確認ができるよう、起動されるジョブは処理に時間がかかるようにする
|
* ログ出力により、ポーリングが実行されていること
* ジョブ実行中に、ジョブ要求テーブルのPOLLEDの件数がポーリング件数と一致すること

|===

[[executeJob]]
==== ジョブの実行のテスト
ジョブの実行を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|異常系 +
非同期型起動(DBポーリング)
|ジョブ要求に設定された内容でジョブが起動しない
|
* 存在しないジョブ名でジョブ要求を作成する
* 非同期バッチデーモンを起動する
|
* ログ出力により、ジョブ実行時エラーが発生したこと
* ジョブ要求テーブルがEXECUTEDになり、job_execution_idが更新されていないこと

|2
|正常系 +
非同期型起動(DBポーリング)
|同時並行数より多くのジョブが起動しないこと
|
* 初期データとしてジョブ要求を20件登録しておく
* ポーリング件数(＝同時並行数)を5件に設定して、非同期デーモンを起動する
* 複数回ポーリングされても同じジョブが起動中であることが確認できるくらいのジョブを実行する
|
* ログ出力により、ポーリングが実行されていることを
* ジョブ要求テーブルが同時並行数分だけPOLLEDになっていること
* ログ出力により、TaskRejectionが発生していること

|===

[[stopDaemon]]
==== デーモンの停止のテスト
デーモンの停止を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
非同期型起動(DBポーリング)
|実行中のジョブが終了してから、非同期デーモンが停止されること
|
* 非同期ジョブが実行中に、指定したファイルを作成する
|
* ログ出力により、正常に終了されたこと
* ログ出力により、ジョブが終了してからデーモンが停止したこと

|2
|異常系 +
非同期型起動(DBポーリング)
|非同期バッチデーモンが起動する前に、停止ファイルが作成されている場合、非同期バッチデーモンが即時停止すること
|
* 非同期ジョブを起動する前に、指定したファイルを作成する
* 非同期バッチデーモンを起動する
** 初期データとしてジョブ要求を5件登録しておく
** ポーリング初期実行遅延時間を5秒に設定
|
* ログ出力により、異常に終了されたこと
* ログ出力により、ポーリングが開始されていないこと。

|3
|異常系 +
非同期型起動(DBポーリング)
|非同期バッチデーモンが起動中に kbd:[Ctrl+C] が押された場合、非同期バッチデーモンがコンテキストをクローズして終了すること。
|
* 非同期ジョブが実行中に、シグナル``SIGINT``を送信する。

[WARNING]
====
自動化のためシグナルを送信する。そのため、Windows環境での試験は実施しない。
====
|
* 終了コードから、SIGINTで終了されたこと
* ログ出力により、コンテキストをクローズして終了したこと

|4
|準正常系 +
非同期型起動(DBポーリング)
|停止ファイルがディレクトリとして作成された場合は、非同期バッチデーモンが停止しないこと
|
* 非同期ジョブが実行中に、指定したファイルをディレクトリとして作成する
|
* ログ出力により、ディレクトリである警告が出力されること
* ログ出力により、デーモンが処理を継続していること

|===


[[pollingStatusTransition]]
=== ポーリングステータスの遷移のテスト
ポーリングステータスの遷移を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
非同期型起動(DBポーリング)
|INIT -> INIT +
同時実行数を超える
2+|<<executeJob>>の項番2

|2
|正常系 +
非同期型起動(DBポーリング)
|INIT -> INIT +
楽観ロックで排他された場合
2+|<<multipleDaemons>>の項番1

|3
|正常系 +
非同期型起動(DBポーリング)
|INIT -> POLLED
2+|<<executeJob>>の項番2

|4
|正常系 +
非同期型起動(DBポーリング)
|POLLED -> EXECUTED
2+|<<executeJob>>の項番2


|===

[[abnormalityDBPolling]]
=== DBポーリングで異常が発生した場合のテスト
DBポーリングで異常が発生した場合を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|異常系 +
非同期型起動(DBポーリング)
|ジョブが利用するデータソース(``jobDataSource``)への変更はトランザクションがロールバックされる
|
* 非同期デーモンにより起動されたジョブが終了する前に非同期デーモンのプロセスを終了させる
** Windowsは、groovyのprocess#waitForOrKillの利用
** Linuxは、OSのシグナル(``kill - 9``)送信
*** OSについては試験実施環境を参照
* 起動されるジョブは、単一トランザクションジョブとする
|
* ジョブ要求テーブルのステータスがPOLLEDのまま
* ジョブによる更新はロールバックされている

|2
|異常系 +
非同期型起動(DBポーリング)
|リトライせずに次のポーリングタスクを実施
|
* ポーリング中にジョブ要求テーブルをドロップする
* 数回のポーリング後にジョブ要求テーブルを再作成する
* 再作成後にジョブ要求を１件登録する
|
* ログにより、エラー発生の有無に関係なく定期的にポーリングが行われている
* ログにより、エラー回復後に正常にジョブ起動まで含めた処理が行われている

|3
|異常系 +
非同期型起動(DBポーリング)
|JobExecutionIdの更新に失敗する
|
* ジョブ要求テーブルにジョブを登録する
* JobExecutionIdの更新中にDB障害を発生させる
* *この試験はDB障害を発生させるなど環境依存の試験になり自動化は困難である。手動試験でも環境別の手順が必要になり煩雑になるため、UT実施にて確認済みとして機能試験としては実施しない。*
|
* ログ出力により、JobExecutionIdの更新に失敗していることを確認する

|===

[[recoveryJobAbnormalTermination]]
=== ジョブ異常終了時のリカバリのテスト
ジョブ異常終了時のリカバリを確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
非同期型起動(DBポーリング)
|リラン
2+|別レコードをINSERTとすることから、通常の処理と同じになるため試験不要

|2
|正常系 +
非同期型起動(DBポーリング)
|リスタート
|
. 非同期バッチデーモンから、リスタート可能ジョブを起動する
.. ジョブ要求テーブルには１件だけ登録されていること
.. 非同期バッチデーモンから起動された場合、リスタート可能ジョブは異常終了させる
. ジョブ要求テーブルからjob_execution_idを取得する
. 取得したjob_execution_idを引数として、同期型起動でリスタート処理を行う
|
* ログ出力から、リスタートポイントからジョブが再処理されていることを確認する

|3
|正常系 +
非同期型起動(DBポーリング)
|停止
|
. 非同期バッチデーモンから、ジョブを起動する
.. ジョブ要求テーブルには１件だけ登録されていること
.. 割り込み可能な長期ジョブを実行する
. ジョブリポジトリから実行中のジョブのjob_execution_idを取得する
. 取得したjob_execution_idを引数として、同期型起動で停止処理を行う
|
* ログ出力から、ジョブが強制的に停止したこと
** 正常系の終了ログが出ていないことを確認するで大丈夫だと思う
* ジョブ要求テーブルがEXECUTEDになり、job_execution_idが更新されていることを確認する
* ジョブリポジトリから正常終了でないことを確認する

|===

[[customizingJobRequestTable]]
=== ジョブ要求テーブルのカスタマイズのテスト
ジョブ要求テーブルのカスタマイズを確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
非同期型起動(DBポーリング)
|カスタマイズしたテーブルおよびSQLが利用できる
|
* ジョブ要求テーブルに優先順位の項目を追加
* ジョブ要求テーブルのソート順を優先順位 -> job_seq_idにする
* 非同期バッチデーモンへは、カスタマイズした``async-batch-daemon.xml``を使用する
|
* ログ出力から、ソート順にジョブが実行されていること
** 同時並行数内では順不同になる可能性があることに注意

|2
|正常系 +
非同期型起動(DBポーリング)
|カスタマイズしたテーブルおよびSQLが利用できる +
SQLはパラメータを受け取り、検索条件とする
|
* ジョブ要求テーブルにグループIDの項目を追加
* ジョブ要求テーブルの検索条件にグループIDを追加する
* 非同期バッチデーモンへは、カスタマイズした``async-batch-daemon.xml``を使用する
* 環境変数でグループIDを指定する
|
* ログ出力から、環境変数で指定したグループIDのジョブ要求のみ処理されていること
*
|===

[[customizingClock]]
=== クロックのカスタマイズのテスト
タイムスタンプに用いるクロックのカスタマイズを確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
非同期型起動(DBポーリング)
|クロックの日時を固定し、タイムゾーンを変更したクロックでポーリングタスクが実施されること
|
* ``async-batch-daemon.xml``をカスタマイズする
** 日時の固定とタイムゾーンの変更
* 非同期バッチデーモンへは、カスタマイズした``async-batch-daemon.xml``を使用する
|
* ジョブ要求テーブルの``update_date``がカスタマイズした``async-batch-daemon.xml``で指定した日時になっていること

|===


[[multipleDaemons]]
=== デーモンの複数起動のテスト
デーモンの複数起動を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
非同期型起動(DBポーリング)
|楽観ロック +
ジョブが排他的に実行される
|
. 試験プロセスがジョブ要求テーブルのINITレコードを更新中の状態にしておく
. 非同期デーモンのプロセスを２つ起動する
** どちらのプロセスかはログでわかるようにする
*** 機能IDか試験IDに識別子を付加する
. 2つのデーモンプロセスがポーリングを開始したことを確認したら、更新中のレコードをロールバックする
|
ログ出力により、どちらかのデーモンでジョブが処理されたこと

|===

[[modularization]]
=== モジュール化のテスト
モジュール化を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
非同期型起動(DBポーリング)
|モジュール化をしているためにBeanが上書きされない
|
* AutomaticJobRegistrarを用いた非同期デーモンのBean定義を用意する(デフォルト提供を利用)
* ２つのジョブ定義を用意し、それぞれのジョブで使用する別実装コンポーネントのBeanIdを重複するようにする
* 用意したBean定義を利用して非同期デーモンを起動し、ジョブを実行する
|
* ログ出力により、２つのジョブで意図した別々のコンポーネント処理が呼ばれていること

|===
