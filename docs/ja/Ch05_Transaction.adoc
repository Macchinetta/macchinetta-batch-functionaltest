= トランザクション制御の機能試験
:table-caption!:
:icons: font
:sectnums!:

== テストケース
テストケースクラス：jp.co.ntt.fw.macchinetta.batch.functionaltest.ch05.TransactionSpec

[cols="5,25a,70a", options="headers"]
.テストケース一覧
|===
|項番
|テストケース
|確認事項

|1
|<<singleDataSource>>
|
. チャンクモデル
. タスクレットモデル
. 非トランザクショナルなデータソース

|1-1
|<<chunkModel>>
|
* 中間コミット方式実現の確認
** フレームワークによるトランザクション制御

|1-2
|<<taskletModel>>
|
* 中間コミット方式実現の確認
** トランザクションマネージャをインジェクションして操作
* 一括コミット方式実現の確認
** フレームワークによるトランザクション制御


|1-3
|<<nonTransactionalDataSource>>
|
* ファイル出力時のトランザクション制御

|2
|<<multiDataSource>>
|
. 複数データソースからの取得
. 複数データソースへの出力

|2-1
|<<multiDataSourceInput>>
|付随データの取得方法の確認

* ステップ実行前に取得
* ItemProcessorで都度取得

|2-2
|<<multiDataSourceOutput>>
|
* 複数ステップでの出力
* １ステップでの出力
** 複数データベース（スキーマ）
** 非トランザクショナルリソースとの同時出力

|===

== 試験項目一覧
各試験の項目一覧を示す。

:sectnums:
:leveloffset: -1

[[singleDataSource]]
=== 単一データソースのトランザクション制御テスト
単一データソースのトランザクション制御を確認する。

[[chunkModel]]
==== チャンクモデルのトランザクション制御テスト
チャンクモデルのトランザクション制御を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|異常系 +
同期型起動
|中間コミット方式実現の確認
|
* チャンクモデルのジョブを実行
** チャンクサイズ=10とする
* 全データ100件中の途中でエラーを発生させる
** エラーが発生した時点で処理は中断する
|
* テーブルから、エラーデータを含むチャンクの前までのデータが更新されている
* テーブルから、エラーデータを含むチャンクデータは更新されていない（ロールバック）

|===

[[taskletModel]]
==== タスクレットモデルのトランザクション制御テスト
タスクレットモデルのトランザクション制御を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|異常系 +
同期型起動
|中間コミット方式実現の確認
|
* トランザクションマネジャーによるトランザクション制御を実装する
* チャンクモデルのジョブを実行
** チャンクサイズ=10とする
* 全データ100件中の途中でエラーを発生させる
** エラーが発生したデータで処理を中断
|
* テーブルから、エラーデータを含むチャンクの前までのデータが更新されている
* テーブルから、エラーデータを含むチャンクデータは更新されていない（ロールバック）

|2
|異常系 +
同期型起動
|一括コミット方式実現の確認
|
* タスクレットモデルのジョブを実行
* 全データ100件中の途中でエラーを発生させる
** エラーが発生した時点で処理は中断する
|
* テーブルから、全データが更新されていない（ロールバック）

|3
|正常系 +
同期型起動
|中間コミット方式実現の確認
|
* トランザクションマネジャーによるトランザクション制御を実装する
* チャンクモデルのジョブを実行
** チャンクサイズ=10とする
* 全データ100件をエラー無く更新する
|
* テーブルから、全データ100件が更新されている

|4
|正常系 +
同期型起動
|中間コミット方式実現の確認
|
* トランザクションマネジャーによるトランザクション制御を実装する
* チャンクモデルのジョブを実行
** チャンクサイズ=10とする
* 全データ99件をエラー無く更新する
|
* テーブルから、全データ99件が更新されている

|===


[[nonTransactionalDataSource]]
==== 非トランザクショナルなデータソースのトランザクション制御テスト
非トランザクショナルなデータソースのトランザクション制御を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|異常系 +
同期型起動
|ファイル出力時のトランザクション制御
|
* チャンクモデルのジョブを実行する
** チャンクサイズ=10とする
* 出力はFlatFileItemWriterを使用する
** transactionalはtrue
* 全データ100件中の途中でエラーを発生させる
** CompositeItemWriterを使用して、例外発生用のWriterを用意する
*** ファイル出力後に例外を発生させる
|
* 出力ファイルから、エラーデータを含むチャンクの前までのデータが出力されている
* 出力ファイルから、エラーデータを含むチャンクデータは出力されていない（ロールバック）

|2
|異常系 +
同期型起動
|ファイル出力時のトランザクション制御
|
* チャンクモデルのジョブを実行する
** チャンクサイズ=10とする
* 出力はFlatFileItemWriterを使用する
** transactionalはfalse
* 全データ100件中の途中でエラーを発生させる
** CompositeItemWriterを使用して、例外発生用のWriterを用意する
*** ファイル出力後に例外を発生させる
|
* 出力ファイルから、エラーが発生する直前のデータを含むチャンクまでのデータが出力されている（非トランザクション）
** 別のItemWriterがエラーを起こすため、正常系のItemWriterはチャンクのデータをすべて処理している
* 出力ファイルから、エラーデータを含むデータ以降は出力されていない

|===

[[multiDataSource]]
=== 複数データソースのトランザクション制御テスト
複数データソースのトランザクション制御を確認する。

[[multiDataSourceInput]]
==== 複数データソースからの取得テスト
複数データソースからの取得を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
同期型起動
|ステップ実行前に付随データ取得
|
* ２つのスキーマを用意する
.. マスタデータ
.. 処理対象レコードデータ、処理結果
* ステップ実行前に付随データを取得する
** ステップコンテキストに取得したデータを格納する
* ItemProcessorで付随データと処理対象データを結合
* ItemWriterで結合データをファイル出力
|
* ログ出力により、ステップ実行前にデータが取得されること
** マスタ参照が１回のSQL発行だけであること
* 出力ファイルより、マスタと処理対象データが結合した形で出力されていること

|2
|正常系 +
同期型起動
|ItemProcessorで付随データを都度取得
|
* ２つのスキーマを用意する
.. 付随データ
.. 処理対象レコードデータ、処理結果
* ステップ実行前に付随データを取得する
** ステップコンテキストに取得したデータを格納する
* ItemProcessorで付随データと処理対象データを結合
* ItemWriterで結合データをファイル出力
|
* ログ出力により、ItemProcessorで都度データが取得されること
** マスタ参照のSQLが都度発行されていること
* 出力ファイルより、付随データと処理対象データが結合した形で出力されていること

|===

[[multiDataSourceOutput]]
==== 複数データソースへの出力テスト
複数データソースへの出力を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|異常系 +
同期型起動
|複数ステップでの出力
|
* 2つのスキーマを用意する
* スキーマごとにステップを設定し、更新処理を行う。
* チャンクモデルのジョブ
** チャンクサイズ=10
* 全データ100件中の途中でエラーを発生させる
** エラーが発生した時点で処理は中断する
** エラー発生のタイミングは２ステップ目の途中
|
* ジョブリポジトリから、１ステップ目は正常終了している
* 1ステップ目の対象スキマーのテーブルから、全件更新されている
* ジョブリポジトリから、2ステップ目は異常終了している
* 2ステップ目の対象スキマーのテーブルから、
** エラーデータを含むチャンクの前までのデータが更新されている
** エラーデータを含むチャンクデータは更新されていない（ロールバック）

|2
|異常系 +
同期型起動
|1ステップでの出力
|
* 2つのスキーマを用意する
* ChainedTransactionManagerを設定し、更新処理を行う。
* チャンクモデルのジョブ
** チャンクサイズ=10
* 全データ100件中の途中でエラーを発生させる
** エラーが発生した時点で処理は中断する
* ItemWriterにMyBatisのMapperをInjectionする形にする
|
* 各スキーマのテーブルから、エラーデータを含むチャンクの前までのデータが更新されている
* 各スキーマのテーブルから、エラーデータを含むチャンクデータは更新されていない（ロールバック）


|3
|異常系 +
同期型起動
|トランザクショナルリソースと非トランザクションナルリソースの同時処理
|
* チャンクモデルのジョブを実行する
** チャンクサイズ=10とする
** ファイル出力 -> DB更新の順番で処理
* ファイル出力はFlatFileItemWriterを使用する
** transactionalはtrue
* 全データ100件中の途中でエラーを発生させる
** CompositeItemWriterを使用する
*** ファイル出力後に例外を発生させる
|
* 出力ファイルから、エラーデータを含むチャンクの前までのデータが出力されている
* 出力ファイルから、エラーデータを含むチャンクデータは出力されていない（ロールバック）
* DBから、エラーデータを含むチャンクの前までのデータが出力されている
* DBから、エラーデータを含むチャンクデータは出力されていない（ロールバック）

|4
|異常系 +
同期型起動
|トランザクショナルリソースと非トランザクションナルリソースの同時処理
|
* チャンクモデルのジョブを実行する
** チャンクサイズ=10とする
** ファイル出力 -> DB更新の順番で処理
* ファイル出力はFlatFileItemWriterを使用する
** transactionalはfalse
* 全データ100件中の途中でエラーを発生させる
** CompositeItemWriterを使用する
*** ファイル出力後に例外を発生させる
|
* 出力ファイルから、エラーが発生するデータを含むチャンクのデータが出力されている（非トランザクション）
* 出力ファイルから、エラーデータを含むチャンクの次のチャンクデータ以降は出力されていない
* DBから、エラーデータを含むチャンクの前までのデータが出力されている
* DBから、エラーデータを含むチャンクデータは出力されていない（ロールバック）

|===


|===
