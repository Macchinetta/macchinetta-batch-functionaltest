= 非同期実行(Webコンテナ)の機能試験
:table-caption!:
:icons: font
:sectnums!:

== テストケース
テストケースクラス：jp.co.ntt.fw.macchinetta.batch.functionaltest.ch04.AsyncJobWithWebContainerSpec

[cols="5,25a,70a", options="headers"]
.テストケース一覧
|===
|項番
|テストケース
|確認事項

|1
|<<executionFromWeb>>
|
* *ジョブ依頼に対するレスポンスは早々に返却され、依頼されたジョブは非同期に実行されること*
* 非同期実行するための設定
** JobLauncherのTaskExecutorの変更
*** ThreadPoolTaskExecutorの使用
* JobOperatorからの実行
** ジョブパラメータの入力値検証は、Webアプリケーション側で実施
*** ジョブパラメータの入力値検証に対する試験は不要
* ジョブ起動に失敗した場合は、Webアプリケーションによる例外ハンドリングになるため、試験は不要とする

|2
|ジョブが停止・異常終了したときのリカバリ
|

* 停止・リスタートは原則禁止であるが、使用上の注意をガイドした上で試験を実施する。

|3
|Macchinetta Server Framework (1.x)との連携
|試験対象外

* 依存も連携するための機能提供もしていないため
** ガイドラインでの連携上の留意点などはサンプル作成でのノウハウを記載すればよい

|4
|ジョブステータスの確認
|
* JobExplorerの利用
** Webアプリケーションとして提供する形で試験
** 項番１の結果確認に利用する
* SQLによる直接参照
** JobExplorerが内部的にSQLを発行しているので、SQLによる確認は不要とする。

|5
|環境配備
|試験対象外

* 機能試験を実施 -> ビルト・デプロイ・実行が実施されていることになる

|6
|複数起動
|試験対象外

* 並列性を確保する機能は提供していないため
** LBやリクエスト側が担保する必要ある

|===

=== 試験用のWebアプリケーションの仕様
RESTアプリケーションとして、以下の機能を提供する

* ジョブの実行
** JobOperatorによる実行
*** JobExecutionIdが返却される
* ジョブの実行状況・結果確認
** JobExplorerによる検索
*** 返却されてJobExecutionIdが主キーとなる

== 試験項目一覧
各試験の項目一覧を示す。

:sectnums:
:leveloffset: -1

[[executionFromWeb]]
=== Webアプリケーションからのバッチ実行のテスト
Webアプリケーションからのバッチ実行を確認する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
非同期型起動（Webコンテナ）
|Webアプリケーションからのバッチ実行
|
* JobLauncherのTaskExecutorをThreadPoolExecutorにする
** 同時実行数を3、キューキャパシティを10とする
* REST経由でジョブを実行する
** ジョブはモジュール化されている
** 取得したJobExecutionIdを利用して、実行状況・結果を確認する
*** 実行状況を確認できるくらいのロングバッチ処理のジョブとする
|
* REST経由で、ジョブの実行状況・結果を確認
** ジョブが実行中であること -> 非同期実行されていることが確認できる

|2
|正常系 +
非同期型起動（Webコンテナ）
|Webアプリケーションからのバッチ実行
|
* JobLauncherのTaskExecutorをThreadPoolExecutorにする
** 同時実行数を3、キューキャパシティを10とする
* REST経由でジョブを５件連続で実行依頼する
|
* 3件だけ同時実行されていること
** ログ出力から
** REST経由のJobExplorerから

|3
|異常系 +
非同期型起動（Webコンテナ）
|Webアプリケーションからのバッチ実行
|
* JobLauncherのTaskExecutorをThreadPoolExecutorにする
** 同時実行数を3、キューキャパシティを10とする
* REST経由でジョブを14件連続で実行依頼する
** TaskRejectionを確認するため、比較的長いジョブ処理とする
|
* ログ出力により、14件目がTaskRejectionされること

|===

[[executionFromWeb]]
=== ジョブが停止・異常終了したときのリカバリ
ジョブのstep途中停止とリカバリを実施する。

[cols="5,20,25a,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|異常系（リスタート） +
非同期型起動（Webコンテナ）
|Webアプリケーションからのバッチ実行
|
* stepを2つ用意する。
** 1つ目のstepを実行時に`jobExecutionId`をもとにジョブの停止を実行する。
** ジョブ停止中のステータスを確認後、1つ目のstepを終了させる。
*** 実行状況を確認できるくらいのロングバッチ処理のジョブとする
** ジョブの停止確認後、`jobExecutionId`を使用しジョブのリスタートを行う。
|
* REST経由で、ジョブの停止状況・結果を確認
** ジョブが停止中であること -> 停止されたことが確認できること。
** 2つ目のstepが実行されていないこと。
* REST経由で、ジョブのリスタート状況・結果を確認
** ジョブが完了すること。
** 停止された1つめのstepと、2つめの未実行のstepが完了していること。

|===
