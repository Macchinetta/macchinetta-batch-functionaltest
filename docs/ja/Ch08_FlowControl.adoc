= フロー制御の機能試験
:table-caption!:
:icons: font

== テストケース
テストケースクラス：jp.co.ntt.fw.macchinetta.batch.functionaltest.ch08.FlowControlSpec

[cols="5,25,70a", options="headers"]
.テストケース一覧
|===
|項番
|テストケース
|確認事項

|1
|<<SequentialFlow>>
|シーケンシャルフローのジョブの定義方法を確認する。

* "step"要素 + "next"属性

|2
|<<ConditionalFlow>>
|ステップの結果により条件分岐するジョブの定義方法を確認する。

* "next"要素 + "on"属性

|3
|<<StopCondition>>
|ステップの結果によりジョブを停止する際の定義方法を確認する。

* "End"要素 + "exit-code"属性
* "Fail"要素 + "exit-code"属性
* "Stop"要素 + "restart"属性

|4
|<<PassingDataToFutureSteps>>
|ステップ間のデータの受け渡し方法を確認する。

* ExecutionContextPromotionListener

|===

== 試験項目一覧
各試験の項目一覧を示す。

:sectnums:
:leveloffset: -1

[[SequentialFlow]]
=== シーケンシャルフローのテスト
シーケンシャルフローのジョブの定義方法を確認する。

[cols="5,20,25,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系
|シーケンシャルフローのジョブの実行
|
* ``<batch:flow>``を使用せず、`"step"要素 + "next"属性 を用いて複数のステップをシーケンシャルに連結したジョブを定義する
|
* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** 複数のステップの処理が定義した順番どおりに実行されていること

|2
|異常系
|シーケンシャルフローのジョブの実行
|
* "step"要素 + "next"属性 を用いて複数のステップをシーケンシャルに連結したジョブを定義する
* 途中のステップにおいて処理に失敗させる
|
* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** 途中のステップの処理に失敗していること
*** 失敗したステップ以降の処理が実行されていないこと

|3
|正常系
|シーケンシャルフローのジョブの実行
|
* ``<batch:flow>``を``<batch:job>``の外側に置いたBean定義を用いる。あとは1と同様。
|
* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** 複数のステップの処理が定義した順番どおりに実行されていること

|===

[[ConditionalFlow]]
=== 条件分岐のテスト
ステップの結果により条件分岐するジョブの定義方法を確認する。

[cols="5,20,25,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系
|ステップの結果により条件分岐するジョブの実行
|
* "next"要素 + "on"属性 を用いてステップの結果により条件分岐するジョブを定義する
** "stepA"の実行結果が"FAILED"であれば"stepC"へ遷移、"COMPLETED"であれば"stepB"へ遷移する
* 条件分岐の判定条件となるステップの実行結果が"COMPLETED"となるように実行する
|定義したとおりにステップの結果により条件分岐が行われていること

* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** "stepA"、"stepB"が実行されており、"stepC"が実行されていないこと

|2
|正常系 +
項番1と異なる方向への分岐
|ステップの結果により条件分岐するジョブの実行
|* 項番1にて定義したジョブを実行対象とする
* 条件分岐の判定条件となるステップの実行結果が"FAILED"となるように実行する
|定義したとおりにステップの結果により条件分岐が行われていること

* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** "stepA"、"stepC"が実行されており、"stepB"が実行されていないこと

|3
|異常系
|ステップの結果により条件分岐するジョブの実行
|* "next"要素 + "on"属性 を用いてステップの結果により条件分岐するジョブを定義する
* 条件分岐の判定条件となるステップの実行結果がいずれの判定条件にも該当しないように実行する
|例外が発生し、ジョブが失敗すること

* ログ出力
** 条件分岐の判定の際に例外が発生していること
* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** ジョブが失敗しており、後続のジョブが実行されていないこと

|4
|異常系 +
項番2の代替ステップの失敗と回復
|ステップの結果により条件分岐するジョブの実行と回復処理
|* "next"要素 + "on"属性 を用いてステップの結果により条件分岐するジョブを定義する
* 試験項目2.と同様に代替ステップに遷移させ、さらに代替ステップが失敗したとき、
リスタート時に代替ステップのみが再実行されること
|

1. 代替ステップ失敗の確認
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** "stepA"、"stepC"が実行されており、"stepB"が実行されていないこと
*** "stepA"の終了ステータスが"ABANDONED"であること
*** "stepC"の終了ステータスが"FAILED"であること

2. リスタートによる回復の確認
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** "stepA"がスキップされ、"stepC"が再実行されること
*** "stepC"の終了ステータス"COMPLETED"であるレコードが追加されていること
*** ジョブステータス"COMPLETED"のレコードが追加されていること

|===

[[StopCondition]]
=== 停止条件のテスト
ステップの結果によりジョブを停止する際の定義方法を確認する。

[cols="5,20,25,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
"End"要素を使用 +
"exit-code"属性不使用
|"End"要素を使用して停止条件のを指定したジョブの実行
|
* 複数ステップから構成されるシーケンシャルなジョブを定義する
* 途中のステップに"End"要素を使用して停止条件を指定する
** "exit-code"属性は定義しない
* "End"要素を指定したステップの実行結果が"on"属性に指定した値と合致する条件となるようにジョブを実行する
|定義したとおりにジョブが停止されていること

* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** "End"要素を指定したステップにてジョブがステータス"COMPLETED"で停止していること
*** 後続のステップの処理が実行されていないこと

|2
|正常系 +
"End"要素を使用 +
"exit-code"属性使用
|"End"要素を使用して停止条件のを指定したジョブの実行
|
* 複数ステップから構成されるシーケンシャルなジョブを定義する
* 途中のステップに"End"要素を使用して停止条件を指定する
** "exit-code"属性に任意のステータスを定義する
* "End"要素を指定したステップの実行結果が"on"属性に指定した値と合致する条件となるようにジョブを実行する
|定義したとおりにジョブが停止されていること

* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** "End"要素を指定したステップにてジョブが"exit-code"属性に指定したステータスで停止していること
*** 後続のステップの処理が実行されていないこと

|3
|正常系 +
"End"要素を使用 +
ジョブ停止条件に合致しない場合
|"End"要素を使用して停止条件のを指定したジョブの実行
|
* 複数ステップから構成されるシーケンシャルなジョブを定義する
* 途中のステップに"End"要素を使用して停止条件を指定する
** "exit-code"属性の指定は任意
* "End"要素を指定したステップの実行結果が"on"属性に指定した値と合致しない条件となるようにジョブを実行する
|ジョブが停止されずに後続のステップへ処理が移っていること

* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** ジョブが途中で停止せず、最後のステップまで実行されていること

|4
|異常系 +
"Fail"要素を使用 +
"exit-code"属性不使用
|"Fail"要素を使用して停止条件のを指定したジョブの実行
|
* 複数ステップから構成されるシーケンシャルなジョブを定義する
* 途中のステップに"Fail"要素を使用して停止条件を指定する
** "exit-code"属性は定義しない
* "Fail"要素を指定したステップの実行結果が"on"属性に指定した値と合致する条件となるようにジョブを実行する
|定義したとおりにジョブが停止されていること

* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** "End"要素を指定したステップにてジョブがステータス"FAILED"で停止していること
*** 後続のステップの処理が実行されていないこと

|5
|異常系 +
"Fail"要素を使用 +
"exit-code"属性使用
|"Fail"要素を使用して停止条件のを指定したジョブの実行
|
* 複数ステップから構成されるシーケンシャルなジョブを定義する
* 途中のステップに"Fail"要素を使用して停止条件を指定する
** "exit-code"属性に任意のステータスを定義する
* "Fail"要素を指定したステップの実行結果が"on"属性に指定した値と合致する条件となるようにジョブを実行する
|定義したとおりにジョブが停止されていること

* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** "End"要素を指定したステップにてジョブが"exit-code"属性に指定したステータスで停止していること
*** 後続のステップの処理が実行されていないこと

|6
|異常系 +
"Fail"要素を使用 +
ジョブ停止条件に合致しない場合
|"Fail"要素を使用して停止条件のを指定したジョブの実行
|
* 複数ステップから構成されるシーケンシャルなジョブを定義する
* 途中のステップに"Fail"要素を使用して停止条件を指定する
** "exit-code"属性の指定は任意
* "Fail"要素を指定したステップの実行結果が"on"属性に指定した値と合致しない条件となるようにジョブを実行する
|ジョブが停止されずに後続のステップへ処理が移っていること

* (AND条件として統合可能のため、項番3と併用する)
* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** ジョブが途中で停止せず、最後のステップまで実行されていること

|7
|正常系 +
"Stop"要素を使用
|"Stop"要素を使用して停止条件のを指定したジョブの実行
|
* 複数ステップから構成されるシーケンシャルなジョブを定義する
* 途中のステップに"Stop"要素、"restart"属性を使用して停止条件を指定する
. 停止するためにジョブを実行
** "Stop"要素を指定したステップの実行結果が"on"属性に指定した値と合致する条件となるようにジョブを実行する
. リスタートするためにジョブを実行
** 停止時の状態を確認したら、ジョブをリスタートさせる
|

. ジョブが停止したことを確認
* 定義したとおりにジョブが停止されていること
** JobRepository
*** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
**** "Stop"要素を指定したステップにてジョブがステータス"STOPPED"で停止していること
**** 後続のステップの処理が実行されていないこと
**** TODO `BATCH-2315` のバグにより、フロー内停止は exit-code=""（空白）を明示する。

. ジョブがリスタートしたことを確認
** ログから停止前のステップが実行されていないこと
** ログからrestart属性に指定したステップ以降が実行されれいること
** JobRepository
*** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
**** ジョブが正常終了していること
**** 後続のステップの処理が実行されたこと（各ステップが正常終了している）

|8
|正常系 +
"Stop"要素を使用 +
ジョブ停止条件に合致しない場合
|"Fail"要素を使用して停止条件のを指定したジョブの実行
|
* 複数ステップから構成されるシーケンシャルなジョブを定義する
* 途中のステップに"stop"要素を使用して停止条件を指定する
* "stop"要素を指定したステップの実行結果が"on"属性に指定した値と合致しない条件となるようにジョブを実行する
|ジョブが停止されずに後続のステップへ処理が移っていること

* (AND条件として統合可能のため、項番3と併用する)
* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
*** ジョブが途中で停止せず、最後のステップまで実行されていること

|9
|正常系 +
"Stop"要素を使用  +
"exit-code"属性使用
|"Fail"要素を使用して停止条件のを指定したジョブの実行
|
* 複数ステップから構成されるシーケンシャルなジョブを定義する
* 途中のステップに"stop"要素を使用して停止条件を指定する
* "stop"要素を指定したステップの実行結果が"on"属性に指定した値と合致しない条件となるようにジョブを実行する
|ジョブが停止されずに後続のステップへ処理が移っていること

* TODO 本試験は BATCH-2315 のバグにより、カスタムなexit-codeによる非停止フローが指定できない。
このため、下記「最後のステップ」はNOOPとなる。
* JobRepository
** BATCH_JOB_EXECUTION, BATCH_STEP_EXECUTION
** "Stop"要素を指定したステップにてジョブが"exit-code"属性に指定したステータスで停止していること
*** ジョブが途中で停止せず、最後のステップまで実行されていること

|===

[[PassingDataToFutureSteps]]
=== ステップ間のデータの受け渡しのテスト
ステップ間のデータの受け渡し方法を確認する。

[cols="5,20,25,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系
|ステップ間でデータを受け渡すジョブの実行(タスクレット方式)
|
* 引数から得られる``ExecutionContext``を介し、``ExecutionContextPromotionListener``を用いてステップ間でデータを受け渡すジョブを定義する。
|ステップ間でデータが受け渡されていること

* ログ出力orジョブの出力結果
** ステップ間でデータが受け渡されていること

|2
|正常系
|ステップ間でデータを受け渡すジョブの実行(チャンク方式)
|
* ``ItemProcessor``と``@AfterStep``、``@BeforeStep``を使用して``ExecutionContext``を介し、``ExecutionContextPromotionListener``を用いてステップ間でデータを受け渡すジョブを定義する。
|ステップ間でデータが受け渡されていること

* ログ出力orジョブの出力結果
** ステップ間でデータが受け渡されていること

|===
