= ジョブ起動パラメータの機能試験
:table-caption!:
:icons: font

== テストケース
テストケースクラス：jp.co.ntt.fw.macchinetta.batch.functionaltest.ch04.JobParameterSpec

[cols="5,25,70a", options="headers"]
.テストケース一覧
|===
|項番
|テストケース
|確認事項

|1
|<<jobParameterConverterClass>>
|JsrJobParameterConverterの利用確認

|2
|<<commandLineAndReference>>
|
* コマンドラインからのパラメータ渡し
** 直接渡し
** ファイルから標準入力へリダイレクト
* ジョブパラメータ参照
** XML(Bean定義)
** Java

icon:tag[] 非同期起動のパラメータ渡しにの確認ついては、非同期機能の試験で実施する。
|3
|<<jobParamaterValidator>>
|
* 簡易な妥当性検証
** DefaultJobParametersValidatorの利用
*** 必須と意図しないパラメータがないことの確認
* 自作の妥当性検証クラスの実装
** 数値、日時、相関（パラメータ間）の検証

|4
|<<combinationParametersAndProperties>>
|
* 環境変数との併用
** 直接設定
*** XML(Bean定義)
*** Java
** デフォルト値としての適用
*** XML(Bean定義)
*** Java

icon:tag[] プロパティファイルについては、プロパティ管理機能を利用することで、最終的には環境変数と同じになるので試験しない

|===

== 試験項目一覧
各試験の項目一覧を示す。

:sectnums:
:leveloffset: -1

[[jobParameterConverterClass]]
=== パラメータ変換クラスのテスト
JsrJobParameterConverterが採用されていることを確認する。

[cols="5,20,25,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
同期型起動
|同一ジョブ実行のテスト
|
* JobRepositoryは永続DBを使用する
* 同一ジョブを２回実行する
|
* 別ジョブとしてそれぞれ実行されていること
** ``jsr_batch_run_id``が自動的に付加されていること
** ``jsr_batch_run_id``が異なること
* JobRepositoryの``batch_job_execution_params``を確認

|2
|正常系 +
非同期型起動（DBポーリング）
|同一ジョブ実行のテスト
|
* JobRepositoryは永続DBを使用する
* 同一ジョブを２回実行する
|
* 別ジョブとしてそれぞれ実行されていること
** ``jsr_batch_run_id``が自動的に付加されていること
** ``jsr_batch_run_id``が異なること
* JobRepositoryの``batch_job_execution_params``を確認

|===

[[commandLineAndReference]]
=== パラメータの渡し方と参照方法のテスト
コマンドラインからのジョブパラメータの渡し方と参照方法を確認する。

[cols="5,20,25,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
同期型起動
|ジョブパラメータのコマンドラインからの直接渡し
|
* パラメータの参照方法はXML（Bean定義）による参照とする
* 文字列、数値、日時(yyyy-MM-dd_HH:mm:ss)の値を渡す
** パラメータが有効な値を渡す
** スペースが含まれているとテストがしにくいのでアンスコで繋ぐ

※日時はString型で渡し、業務処理の中(Setter等)でDate型等に変換する
|
* 渡されたパラメータが正しく設定されていること
** ログ出力により、自動的に型変換されて設定されていること

|2
|正常系 +
同期型起動
|ジョブパラメータのコマンドラインからの直接渡し
|
* パラメータの参照方法はJavaによる参照とする
* 文字列、数値の値を渡す
** パラメータが有効な値を渡す
|
* 渡されたパラメータが正しく設定されていること
** ログ出力により、自動的に型変換されて設定されていること

|3
|異常系 +
同期型起動
|ジョブパラメータのコマンドラインからの直接渡し
|
* パラメータの参照方法はJavaによる参照とする
* 文字列、数値の値を渡す
** 形式が無効な値を渡す
*** key=value以外の形式
|
* ログ出力によりのエラーが発生していること

|4
|正常系 +
同期型起動
|ジョブパラメータのファイルから標準入力へリダイレクト
|
* パラメータの参照方法はJavaによる参照とする
* 文字列、数値の値を渡す
** 型変換が有効な値を渡す
|
* 渡されたパラメータが正しく設定されていること
** ログ出力により、自動的に型変換されて設定されていること

|5
|正常系 +
同期型起動
|ジョブパラメータのコマンドラインからの直接渡し
|
* パラメータの参照方法はJavaによる参照とする
* 文字列、数値の値を渡す
** 参照されないKeyをもつパラメータを指定する
|
* 参照されないkey以外の渡されたパラメータが正しく設定されていること
** ログ出力により、自動的に型変換されて設定されていること
* 正常終了すること

|===

[[jobParamaterValidator]]
=== パラメータの妥当性検証のテスト
ジョブパラメータの妥当性検証の方法を確認する。

[cols="5,20,25,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|異常系 +
同期型起動
|DefaultJobParametersValidatorによる検証
|
* 設定
** 必須パラメータ名を指定
** オプションパラメータ名を指定
* 必須パラメータを指定せずジョブを実行
|
* ログ出力により、必須エラーが発生すること

|2
|正常系 +
同期型起動
|DefaultJobParametersValidatorによる検証
|
* 設定
** 必須パラメータ名を指定
** オプションパラメータ名を指定
* 必須パラメータ・オプションパラメータ以外を指定してジョブを実行
|
* 正常終了すること

|3
|正常系 +
同期型起動
|DefaultJobParametersValidatorによる検証
|
* 設定
** 必須パラメータ名を指定
** オプションパラメータ名を指定
* 必須パラメータのみを指定してジョブを実行
|
* 正常終了すること

|4
|正常系 +
同期型起動
|DefaultJobParametersValidatorによる検証
|
* 設定
** 必須パラメータ名を指定
** オプションパラメータ名を指定
* 必須パラメータとオプションパラメータを指定してジョブを実行
|
* 正常終了すること

|5
|異常系 +
同期型起動
|自作のJobParamatersValidatorを実装
|
* パラメータ間の相関を検証する
* パラメータ間の相関の検証でエラーになるパラメータを指定する
|
* ログ出力により、パラメータ間の相関の検証でエラーが発生すること

|6
|正常系 +
同期型起動
|自作のJobParamatersValidatorを実装
|
* 数値、パラメータ間の相関を検証する
* 検証が通るパラメータを指定する
|
* 正常終了することを確認

|===

[[combinationParametersAndProperties]]
=== ジョブパラメータとプロパティの併用
ジョブパラメータとプロパティの併用方法を確認する。

[cols="5,20,25,25a,25a", options="header"]
.試験項目一覧
|===
|項番
|観点
|試験項目
|試験条件
|確認内容

|1
|正常系 +
同期型起動
|環境変数も同時に設定する
|
* ジョブパラメータと環境変数を同時に指定する
* パラメータの参照方法はXML（Bean定義）による参照とする
** 各々が設定するパラメータは別パラメータとする
|
* ログ出力により、パラメータと環境変数が設定されていること

|2
|正常系 +
同期型起動
|環境変数も同時に設定する
|
* ジョブパラメータと環境変数を同時に指定する
* パラメータの参照方法はJavaによる参照とする
** 各々が設定するパラメータは別パラメータとする
|
* ログ出力により、パラメータと環境変数が設定されていること

|3
|正常系 +
同期型起動
|環境変数も同時に設定する
|
* ジョブパラメータと環境変数を同時に指定する
* パラメータの参照方法はXML（Bean定義）による参照とする
** 環境変数がデフォルト値となる設定を行う
[source,xml]
----
<bean>
  <property name="param1"
    value="#{jobParameters[param1] ?: `${env1}`}"/>
</bean>
----
|
* ログ出力により、ジョブパラメータの値が設定されていること

|4
|正常系 +
同期型起動
|環境変数も同時に設定する
|
* ジョブパラメータと環境変数を同時に指定する
* パラメータの参照方法はJavaによる参照とする
** 環境変数がデフォルト値となる設定を行う
[source,java]
----
@Value("#{jobParameters[param1] ?: `${env1}`}")
public void setParam1(String param1) {
    this.param1 = param1;
}
----
|
* ログ出力により、ジョブパラメータの値が設定されていること

|5
|正常系 +
同期型起動
|環境変数も同時に設定する
|
* 環境変数だけを指定する
* パラメータの参照方法はXML（Bean定義）による参照とする
** 環境変数がデフォルト値となる設定を行う
[source,xml]
----
<bean>
  <property name="param1"
    value="#{jobParameters[param1] ?: `${env1}`}"/>
</bean>
----
|
* ログ出力により、環境変数の値が設定されていること

|6
|正常系 +
同期型起動
|環境変数も同時に設定する
|
* 環境変数だけを指定する
* パラメータの参照方法はJavaによる参照とする
** 環境変数がデフォルト値となる設定を行う
[source,java]
----
@Value("#{jobParameters[param1] ?: `${env1}`}")
public void setParam1(String param1) {
    this.param1 = param1;
}
----
|
* ログ出力により、環境変数の値が設定されていること

|7
|正常系 +
同期型起動
|環境変数も同時に設定する +
デフォルト値設定方法が正しくないケース
|
* 環境変数だけを指定する
* パラメータの参照方法はJavaによる参照とする
** 環境変数がデフォルト値となる設定を行う
[source,java]
----
@Value("${env1}")
private String param1

@Value("#{jobParameters[param1]")
public void setParam1(String param1) {
    this.param1 = param1;
}
----
|
* ログ出力により、環境変数の値が設定されていないこと

|===
